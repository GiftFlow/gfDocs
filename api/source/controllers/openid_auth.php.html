<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="generator" content="PHPDoctor 2RC4 (http://peej.github.com/phpdoctor/)">
<meta name="when" content="Sat, 24 Jul 2010 20:47:45 +0000">

<link rel="stylesheet" type="text/css" href="../../stylesheet.css">
<link rel="start" href="../../overview-summary.html">

<title>controllers/openid_auth.php (GiftFlow API)</title>

</head>
<body id="file" onload="parent.document.title=document.title;">

<div class="header">
<h1>GiftFlow API</h1>
<ul>
<li><a href="../../overview-summary.html">Overview</a></li>
<li>Package</li><li>Class</li><li>Tree</li><li><a href="../../overview-files.html">Files</a></li>
<li><a href="../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../index-all.html">Index</a></li>
</ul>
</div>

<div class="small_links">
<a href="../../index.html" target="_top">Frames</a>
<a href="../../source/controllers/openid_auth.php.html" target="_top">No frames</a>
</div>
<hr>

<h1>controllers/openid_auth.php</h1>
<hr>

<a name="line1"></a><pre><?php
<a name="line2"></a>class Openid_auth extends Controller {
<a name="line3"></a>
<a name="line4"></a>    function Account()
<a name="line5"></a>    {
<a name="line6"></a>        parent::Controller();
<a name="line7"></a>    }
<a name="line8"></a>    
<a name="line9"></a>    function signin_return()
<a name="line10"></a>    {
<a name="line11"></a>        print_r($_GET);
<a name="line12"></a>    }
<a name="line13"></a>    
<a name="line14"></a>    function signin()
<a name="line15"></a>    {
<a name="line16"></a>        // Request parameters
<a name="line17"></a>        $google_discover_url= "https://www.google.com/accounts/o8/id";
<a name="line18"></a>        $openid_mode= "checkid_setup";
<a name="line19"></a>        $openid_ns= "http://specs.openid.net/auth/2.0";
<a name="line20"></a>        $openid_return_to= "http://localhost/giftflow/openid_auth/signin_return";
<a name="line21"></a>        $openid_assoc_handle= "ABSmpf6DNMw";
<a name="line22"></a>        $openid_claimed_id= "http://specs.openid.net/auth/2.0/identifier_select";
<a name="line23"></a>        $openid_identity= "http://specs.openid.net/auth/2.0/identifier_select";
<a name="line24"></a>        $openid_realm= "giftflow.org";
<a name="line25"></a>        // PAPE extension
<a name="line26"></a>        $openid_ns_pape= "http://specs.openid.net/extensions/pape/1.0";
<a name="line27"></a>        $openid_pape_max_auth_age= "300"; // 5 mins
<a name="line28"></a>        // User interface extension
<a name="line29"></a>        $openid_ui_ns= "http://specs.openid.net/extensions/ui/1.0";
<a name="line30"></a>        $openid_ui_mode= "popup";
<a name="line31"></a>        $openid_ui_icon= "true";
<a name="line32"></a>        // Attribute exchange extension
<a name="line33"></a>        $openid_ns_ax= "http://openid.net/srv/ax/1.0";
<a name="line34"></a>        $openid_ax_mode= "fetch_request";
<a name="line35"></a>        $openid_ax_required= "country,email,firstname,language,lastname";
<a name="line36"></a>        $openid_ax_type_country= "http://axschema.org/contact/country/home";
<a name="line37"></a>        $openid_ax_type_email= "http://axschema.org/contact/email";
<a name="line38"></a>        $openid_ax_type_firstname = "http://axschema.org/namePerson/first";
<a name="line39"></a>        $openid_ax_type_language= "http://axschema.org/pref/language";
<a name="line40"></a>        $openid_ax_type_lastname= "http://axschema.org/namePerson/last";
<a name="line41"></a>		$openid_ns_ext2="http://specs.openid.net/extensions/oauth/1.0";
<a name="line42"></a>        $openid_ns_consumer="giftflow.org";
<a name="line43"></a>		$openid_ext2_scope="http://docs.google.com/feeds/";
<a name="line44"></a>        // Send discovery request to obtain the Google login authentication endpoint
<a name="line45"></a>        $ch = curl_init ();
<a name="line46"></a>        curl_setopt ($ch, CURLOPT_SSL_VERIFYPEER, 0); // See http://unitstep.net/blog/2009/05/05/using-curl-in-php-to-access-https-ssltls-protected-sites/
<a name="line47"></a>        curl_setopt ($ch, CURLOPT_RETURNTRANSFER, 1);
<a name="line48"></a>        curl_setopt ($ch, CURLOPT_URL, $google_discover_url);
<a name="line49"></a>        $content = curl_exec ($ch);
<a name="line50"></a>        curl_close ($ch);
<a name="line51"></a>        $xml = simplexml_load_string($content);
<a name="line52"></a>		/*echo "<pre>";
<a name="line53"></a>		print_r($xml);
<a name="line54"></a>		echo "</pre>";*/
<a name="line55"></a>        $google_endpoint = (string)$xml->XRD->Service->URI;
<a name="line56"></a>       // print_r($google_endpoint);die;
<a name="line57"></a>        // Send login authentication request to the Google endpoint address
<a name="line58"></a>		 /*$urlend = $google_endpoint.
<a name="line59"></a>            '?openid.mode='.$openid_mode.
<a name="line60"></a>            '&openid.ns='.$openid_ns.
<a name="line61"></a>            '&openid.return_to='.$openid_return_to.
<a name="line62"></a>            '&openid.assoc_handle='.$openid_assoc_handle.
<a name="line63"></a>            '&openid.claimed_id='.$openid_claimed_id.
<a name="line64"></a>            '&openid.identity='.$openid_identity.
<a name="line65"></a>            '&openid.realm='.$openid_realm.
<a name="line66"></a>            '&openid.ns.pape='.$openid_ns_pape.
<a name="line67"></a>            '&openid.pape.max_auth_age='.$openid_pape_max_auth_age.
<a name="line68"></a>            '&openid.ui.ns='.$openid_ui_ns.
<a name="line69"></a>            '&openid.ui.mode='.$openid_ui_mode.
<a name="line70"></a>            '&openid.ui.icon='.$openid_ui_icon.
<a name="line71"></a>            '&openid.ns.ax='.$openid_ns_ax.
<a name="line72"></a>            '&openid.ax.mode='.$openid_ax_mode.
<a name="line73"></a>            '&openid.ax.required='.$openid_ax_required.
<a name="line74"></a>            '&openid.ax.type.country='.$openid_ax_type_country.
<a name="line75"></a>            '&openid.ax.type.email='.$openid_ax_type_email.
<a name="line76"></a>            '&openid.ax.type.firstname='.$openid_ax_type_firstname.
<a name="line77"></a>            '&openid.ax.type.language='.$openid_ax_type_language.
<a name="line78"></a>            '&openid.ax.type.lastname='.$openid_ax_type_lastname.
<a name="line79"></a>			'&openid.ns.ext2='.$openid_ns_ext2.
<a name="line80"></a>			'&openid.ext2.consumer='.$openid_ns_consumer.
<a name="line81"></a>			'&openid.ext2.scope='.$openid_ext2_scope;*/
<a name="line82"></a>			
<a name="line83"></a>			$urlend = "https://www.google.com/accounts/o8/id?openid.ns=http://specs.openid.net/auth/2.0&openid.claimed_id=http://specs.openid.net/auth/2.0/identifier_select&openid.identity=http://specs.openid.net/auth/2.0/identifier_select&openid.return_to=http://localhost/giftflow/openid_auth/signin_return&openid.realm=http://www.giftflow.org
<a name="line84"></a>&openid.assoc_handle=ABSmpf6DNMw&openid.mode=checkid_setup&openid.ns.oauth=http://specs.openid.net/extensions/oauth/1.0&openid.oauth.consumer=giftflow.org&openid.oauth.scope=http://docs.google.com/eeds/+http://spreadsheets.google.com/feeds/";
<a name="line85"></a>			
<a name="line86"></a>        $ch = curl_init ();
<a name="line87"></a>        curl_setopt ($ch, CURLOPT_HEADER, 1);
<a name="line88"></a>        curl_setopt ($ch, CURLOPT_SSL_VERIFYPEER, 0); // See 
<a name="line89"></a>        curl_setopt ($ch, CURLOPT_RETURNTRANSFER, 1);
<a name="line90"></a>        curl_setopt ($ch, CURLOPT_URL,  $urlend);
<a name="line91"></a>        $content = curl_exec ($ch);
<a name="line92"></a>        curl_close ($ch);
<a name="line93"></a>        echo $content;
<a name="line94"></a>       // die;
<a name="line95"></a>        // Obtain the Google sign-in page url
<a name="line96"></a>        list($header) = explode("\r\n\r\n", $content, 2);
<a name="line97"></a>		echo $header;
<a name="line98"></a>		die;
<a name="line99"></a>        $matches = array();
<a name="line100"></a>        preg_match('/(Location:)(.*?)\n/', $header, $matches);
<a name="line101"></a>        $signin_url = trim(array_pop($matches));
<a name="line102"></a>        
<a name="line103"></a>        // Either open in redirect or popup , for now just give user a hyperlink
<a name="line104"></a>        echo anchor($signin_url, 'click here');
<a name="line105"></a>    }
<a name="line106"></a>} </pre>
<div class="header">
<h1>GiftFlow API</h1>
<ul>
<li><a href="../../overview-summary.html">Overview</a></li>
<li>Package</li><li>Class</li><li>Tree</li><li><a href="../../overview-files.html">Files</a></li>
<li><a href="../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../index-all.html">Index</a></li>
</ul>
</div>

<div class="small_links">
<a href="../../index.html" target="_top">Frames</a>
<a href="../../source/controllers/openid_auth.php.html" target="_top">No frames</a>
</div>
<hr>

<p id="footer">This document was generated by <a href="http://peej.github.com/phpdoctor/">PHPDoctor: The PHP Documentation Creator</a></p>

</body>

</html>